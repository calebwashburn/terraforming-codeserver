#!/bin/bash -e

wget https://dl.google.com/go/go${go_version}.linux-amd64.tar.gz -O /tmp/golang.tgz
tar -C /usr/local -xzf /tmp/golang.tgz
rm -rf /tmp/golang.tgz

adduser --shell /bin/bash --disabled-login --gecos codeserver codeserver

cat << EOF > /home/codeserver/.bash_profile
export GOPATH=\$HOME/go
export PATH=\$GOPATH/bin:/usr/local/go/bin:\$PATH
EOF

chmod +x /home/codeserver/.bash_profile
chown codeserver:codeserver /home/codeserver/.bash_profile

echo ". ~/.bash_profile" >> /home/codeserver/.bashrc

mkdir -p /var/code-server
wget https://github.com/cdr/code-server/releases/download/${codeserver_version}/code-server-${codeserver_version}-linux-x86_64.tar.gz -O /tmp/code_server.tgz
tar -C /var/code-server -xvf /tmp/code_server.tgz --strip-components=1
chown codeserver:codeserver -R /var/code-server
rm -rf /tmp/code_server.tgz

cat << EOF > /var/code-server/start.sh
#!/bin/bash -e
PASSWORD=${codeserver_password} nohup /var/code-server/code-server > /var/code-server/start.log 2>&1 &
EOF
chmod +x /var/code-server/start.sh
# start code server
su codeserver -c /var/code-server/start.sh

apt-get update -y
apt-get install nginx build-essential -y

cat << EOF > /etc/nginx/conf.d/codeserver.conf
server {
    listen 80; 

    server_name ${host_name};
    
    location / {

        # prevents 502 bad gateway error
        proxy_buffers 8 32k;
        proxy_buffer_size 64k;

        proxy_pass http://127.0.0.1:8080;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header Host \$http_host;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        #proxy_set_header X-NginX-Proxy true;

        # enables WS support
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_read_timeout 999999999;

    }
}
EOF
systemctl restart nginx